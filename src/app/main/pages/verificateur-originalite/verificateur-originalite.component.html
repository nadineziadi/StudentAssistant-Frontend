<div class="verificateur-container">
  <!-- Toast Notification -->
  <div class="toast-container" *ngIf="showToast">
    <div class="toast" [class.toast-success]="toastType === 'success'" 
         [class.toast-error]="toastType === 'error'"
         [class.toast-info]="toastType === 'info'">
      <span class="toast-icon">
        <span *ngIf="toastType === 'success'">âœ“</span>
        <span *ngIf="toastType === 'error'">âš </span>
        <span *ngIf="toastType === 'info'">â„¹</span>
      </span>
      <span class="toast-message">{{ toastMessage }}</span>
      <button class="toast-close" (click)="showToast = false">âœ•</button>
    </div>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">ğŸ”</div>
      <div class="header-text">
        <h1 class="page-title">VÃ©rificateur d'OriginalitÃ©</h1>
        <p class="page-subtitle">DÃ©tection de plagiat par intelligence artificielle</p>
      </div>
    </div>
  </div>

  <!-- Tabs (Removed PDF Reports tab) -->
  <div class="tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'submit'"
      (click)="switchTab('submit')">
      <span class="tab-icon">âœï¸</span>
      <span>Soumettre un essai</span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'history'"
      (click)="switchTab('history')">
      <span class="tab-icon">ğŸ“š</span>
      <span>Mes essais ({{ essays.length }})</span>
    </button>
  </div>

  <!-- Submit Tab -->
  <div class="tab-content" *ngIf="activeTab === 'submit'">
    <div class="submit-card">
      <div class="info-banner">
        <span class="info-icon">ğŸ’¡</span>
        <p>Soumettez votre travail pour vÃ©rifier son originalitÃ©. Notre systÃ¨me IA comparera votre texte avec tous les essais de la base de donnÃ©es.</p>
      </div>

      <form (ngSubmit)="submitEssay()">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">ğŸ“š</span>
              MatiÃ¨re
            </label>
            <select class="form-select" [(ngModel)]="subject" name="subject" required>
              <option value="">SÃ©lectionner...</option>
              <option *ngFor="let s of subjects" [value]="s">{{ s }}</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span class="label-icon">ğŸŒ</span>
              Langue
            </label>
            <select class="form-select" [(ngModel)]="language" name="language" required>
              <option *ngFor="let lang of languages" [value]="lang.code">{{ lang.name }}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">ğŸ“</span>
            Titre <span class="required">*</span>
          </label>
          <input
            type="text"
            class="form-input"
            [(ngModel)]="title"
            name="title"
            placeholder="Titre de votre essai"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">ğŸ“„</span>
            Contenu <span class="required">*</span>
          </label>
          <textarea
            class="form-textarea"
            [(ngModel)]="content"
            name="content"
            placeholder="Ã‰crivez ou collez votre essai ici... (minimum 50 mots)"
            rows="15"
            required
          ></textarea>
          <div class="textarea-footer">
            <div class="character-count">
              <span class="count-badge" [class.warning]="getWordCount() < 50">
                {{ getWordCount() }} mots
              </span>
              <span class="count-info">{{ content.length }} caractÃ¨res</span>
            </div>
            <div class="word-requirement" *ngIf="getWordCount() < 50">
              <span class="warning-icon">âš ï¸</span>
              Minimum 50 mots requis
            </div>
          </div>
        </div>

        <button 
          type="submit" 
          class="btn-submit"
          [disabled]="isSubmitting || getWordCount() < 50"
          [class.loading]="isSubmitting">
          <span *ngIf="!isSubmitting">
            <span class="btn-icon">ğŸš€</span>
            Soumettre et vÃ©rifier
          </span>
          <span *ngIf="isSubmitting" class="loading-spinner">
            <span class="spinner"></span>
            Traitement en cours...
          </span>
        </button>
      </form>
    </div>
  </div>

  <!-- History Tab -->
  <div class="tab-content" *ngIf="activeTab === 'history'">
    <!-- Filters -->
    <div class="filters-bar" *ngIf="essays.length > 0">
      <div class="filter-group">
        <label class="filter-label">MatiÃ¨re:</label>
        <select class="filter-select" [(ngModel)]="filterSubject" (change)="applyFilters()">
          <option value="">Toutes</option>
          <option *ngFor="let s of subjects" [value]="s">{{ s }}</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Statut:</label>
        <select class="filter-select" [(ngModel)]="filterChecked" (change)="applyFilters()">
          <option value="">Tous</option>
          <option value="checked">VÃ©rifiÃ©s</option>
          <option value="unchecked">Non vÃ©rifiÃ©s</option>
        </select>
      </div>

      <button class="btn-clear-filters" (click)="filterSubject=''; filterChecked=''; applyFilters()">
        RÃ©initialiser
      </button>
    </div>

    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner-large"></div>
      <p>Chargement des essais...</p>
    </div>

    <div class="empty-state" *ngIf="!isLoading && essays.length === 0">
      <div class="empty-icon">ğŸ“­</div>
      <h3>Aucun essai soumis</h3>
      <p>Commencez par soumettre votre premier essai pour vÃ©rifier son originalitÃ©</p>
      <button class="btn-secondary" (click)="switchTab('submit')">
        <span class="btn-icon">âœï¸</span>
        Soumettre un essai
      </button>
    </div>

    <div class="empty-state" *ngIf="!isLoading && essays.length > 0 && filteredEssays.length === 0">
      <div class="empty-icon">ğŸ”</div>
      <h3>Aucun rÃ©sultat</h3>
      <p>Aucun essai ne correspond Ã  vos filtres</p>
    </div>

    <div class="essays-grid" *ngIf="!isLoading && filteredEssays.length > 0">
      <div class="essay-card" *ngFor="let essay of filteredEssays">
        <div class="essay-header">
          <div class="essay-info">
            <h3 class="essay-title">{{ essay.title }}</h3>
            <div class="essay-tags">
              <span class="tag tag-subject" *ngIf="essay.subject">
                <span class="tag-icon">ğŸ“š</span>
                {{ essay.subject }}
              </span>
              <span class="tag tag-language" *ngIf="essay.language">
                <span class="tag-icon">ğŸŒ</span>
                {{ essay.language }}
              </span>
            </div>
            <p class="essay-meta">
              <span class="meta-item">
                <span class="meta-icon">ğŸ“…</span>
                {{ formatDate(essay.submittedAt) }}
              </span>
            </p>
          </div>
          <div class="essay-status">
            <span 
              class="status-badge" 
              [class.checked]="essay.isPlagiarismChecked"
              [class.pending]="!essay.isPlagiarismChecked">
              {{ essay.isPlagiarismChecked ? 'âœ“ VÃ©rifiÃ©' : 'â³ En attente' }}
            </span>
          </div>
        </div>

        <div class="essay-content">
          <p class="essay-preview">{{ essay.content.substring(0, 200) }}...</p>
        </div>

        <div class="essay-actions">
          <button 
            class="btn-check"
            (click)="checkPlagiarism(essay.id)"
            [disabled]="isChecking">
            <span class="btn-icon">ğŸ”</span>
            {{ essay.isPlagiarismChecked ? 'Re-vÃ©rifier' : 'VÃ©rifier' }}
          </button>

          <button 
            class="btn-delete"
            (click)="deleteEssay(essay.id, $event)"
            title="Supprimer cet essai">
            <span class="btn-icon">ğŸ—‘ï¸</span>
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal-overlay" *ngIf="showResult" (click)="closeResult()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">ğŸ“Š</span>
          RÃ©sultats de la vÃ©rification
        </h2>
        <button class="modal-close" (click)="closeResult()">âœ•</button>
      </div>

      <div class="modal-body" *ngIf="plagiarismResult">
        <!-- Score Overview Card -->
        <div class="score-card" [style.border-color]="getRiskColor(plagiarismResult.riskLevel)">
          <div class="score-main">
            <div class="score-circle" [style.border-color]="getRiskColor(plagiarismResult.riskLevel)">
              <div class="score-value" [style.color]="getRiskColor(plagiarismResult.riskLevel)">
                {{ getScorePercentage(plagiarismResult.overallPlagiarismScore) }}%
              </div>
              <div class="score-label">SimilaritÃ© max</div>
            </div>
            <div class="score-info">
              <h3 class="score-status" [style.color]="getRiskColor(plagiarismResult.riskLevel)">
                <span class="risk-icon">{{ getRiskIcon(plagiarismResult.riskLevel) }}</span>
                Risque {{ getRiskLabel(plagiarismResult.riskLevel) }}
              </h3>
              <p class="score-description">{{ plagiarismResult.status }}</p>
              <div class="comparison-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ plagiarismResult.matchesFound }}</span>
                  <span class="stat-label">SimilaritÃ©s</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                  <span class="stat-value">{{ plagiarismResult.totalEssaysCompared }}</span>
                  <span class="stat-label">ComparÃ©s</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Risk Level Explanation -->
        <div class="risk-explanation" [style.border-left-color]="getRiskColor(plagiarismResult.riskLevel)">
          <div class="risk-header">
            <span class="risk-title">Que signifie ce score ?</span>
          </div>
          <ul class="risk-list">
            <li *ngIf="plagiarismResult.riskLevel === 'CRITICAL'">
              <strong>Critique (â‰¥95%):</strong> SimilaritÃ© trÃ¨s Ã©levÃ©e. RÃ©vision immÃ©diate nÃ©cessaire.
            </li>
            <li *ngIf="plagiarismResult.riskLevel === 'HIGH'">
              <strong>Ã‰levÃ© (85-94%):</strong> SimilaritÃ©s importantes dÃ©tectÃ©es. VÃ©rification recommandÃ©e.
            </li>
            <li *ngIf="plagiarismResult.riskLevel === 'MODERATE'">
              <strong>ModÃ©rÃ© (70-84%):</strong> Certaines similaritÃ©s prÃ©sentes. Ã€ examiner.
            </li>
            <li *ngIf="plagiarismResult.riskLevel === 'LOW'">
              <strong>Faible (50-69%):</strong> SimilaritÃ©s mineures. Probablement acceptable.
            </li>
            <li *ngIf="plagiarismResult.riskLevel === 'NONE'">
              <strong>Aucun (&lt;50%):</strong> Pas de plagiat significatif dÃ©tectÃ©.
            </li>
          </ul>
        </div>

        <!-- No Matches -->
        <div class="no-matches" *ngIf="plagiarismResult.matchesFound === 0">
          <div class="no-matches-icon">âœ¨</div>
          <h3>Excellent travail !</h3>
          <p>Aucune similaritÃ© significative dÃ©tectÃ©e. Votre travail semble original.</p>
        </div>

        <!-- Matches List -->
        <div class="matches-section" *ngIf="plagiarismResult.matchesFound > 0">
          <h3 class="matches-title">
            <span class="matches-icon">{{ getRiskIcon(plagiarismResult.riskLevel) }}</span>
            Documents similaires trouvÃ©s ({{ plagiarismResult.matchesFound }})
          </h3>

          <div class="matches-list">
            <div class="match-card" *ngFor="let match of plagiarismResult.matches; let i = index">
              <div class="match-number">{{ i + 1 }}</div>
              <div class="match-content">
                <div class="match-header">
                  <div class="match-info">
                    <h4 class="match-title">{{ match.title }}</h4>
                    <div class="match-meta">
                      <span class="match-meta-item">
                        <span class="meta-icon">ğŸ‘¤</span>
                        {{ match.matchedStudentId }}
                      </span>
                      <span class="match-meta-item" *ngIf="match.subject">
                        <span class="meta-icon">ğŸ“š</span>
                        {{ match.subject }}
                      </span>
                      <span class="match-meta-item" *ngIf="match.language">
                        <span class="meta-icon">ğŸŒ</span>
                        {{ match.language }}
                      </span>
                    </div>
                  </div>
                  <div 
                    class="match-score" 
                    [style.background-color]="getRiskColor(match.similarityScore >= 0.95 ? 'CRITICAL' : match.similarityScore >= 0.85 ? 'HIGH' : match.similarityScore >= 0.7 ? 'MODERATE' : 'LOW') + '20'" 
                    [style.color]="getRiskColor(match.similarityScore >= 0.95 ? 'CRITICAL' : match.similarityScore >= 0.85 ? 'HIGH' : match.similarityScore >= 0.7 ? 'MODERATE' : 'LOW')">
                    {{ getScorePercentage(match.similarityScore) }}%
                  </div>
                </div>
                <div class="match-bar">
                  <div 
                    class="match-bar-fill" 
                    [style.width.%]="getScorePercentage(match.similarityScore)"
                    [style.background-color]="getRiskColor(match.similarityScore >= 0.95 ? 'CRITICAL' : match.similarityScore >= 0.85 ? 'HIGH' : match.similarityScore >= 0.7 ? 'MODERATE' : 'LOW')">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Actions -->
        <div class="modal-actions">
          <button class="btn-modal-primary" (click)="closeResult()">
            <span class="btn-icon">âœ“</span>
            Compris
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checking Overlay -->
  <div class="checking-overlay" *ngIf="isChecking">
    <div class="checking-card">
      <div class="spinner-large"></div>
      <h3>VÃ©rification en cours...</h3>
      <p>Analyse de votre essai avec notre IA</p>
      <div class="checking-steps">
        <div class="step">âœ“ GÃ©nÃ©ration des embeddings</div>
        <div class="step">â³ Comparaison avec la base de donnÃ©es</div>
        <div class="step">â³ Calcul des scores de similaritÃ©</div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button for PDF Reports -->
  <button class="fab-pdf" (click)="navigateToThesis()" title="VÃ©rifier un rapport PDF">
    <span class="fab-icon">ğŸ“„</span>
    <span class="fab-tooltip">Rapports PDF</span>
  </button>
</div>
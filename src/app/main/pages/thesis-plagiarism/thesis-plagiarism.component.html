<div class="thesis-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon">ğŸ“„</div>
      <div class="header-text">
        <h1 class="page-title">Rapport de Fin d'Ã‰tudes</h1>
        <p class="page-subtitle">VÃ©rifiez le plagiat dans votre rapport PDF</p>
      </div>
    </div>
    <!-- Stats Badge -->
    <div class="header-stats">
      <div class="stat-badge">
        <span class="stat-value">{{ theses.length }}</span>
        <span class="stat-label">Rapports</span>
      </div>
      <div class="stat-badge">
        <span class="stat-value">{{ getFilterCount('checked') }}</span>
        <span class="stat-label">VÃ©rifiÃ©s</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'upload'"
      (click)="switchTab('upload')">
      <span class="tab-icon">ğŸ“¤</span>
      <span>Importer un rapport</span>
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'history'"
      (click)="switchTab('history')">
      <span class="tab-icon">ğŸ“š</span>
      <span>Mes rapports</span>
      <span class="tab-badge" *ngIf="theses.length > 0">{{ theses.length }}</span>
    </button>
  </div>

  <!-- Messages -->
  <div class="message success-message" *ngIf="successMessage">
    <span class="message-icon">âœ“</span>
    {{ successMessage }}
  </div>

  <div class="message error-message" *ngIf="errorMessage">
    <span class="message-icon">âš </span>
    {{ errorMessage }}
  </div>

  <!-- Upload Tab -->
  <div class="tab-content" *ngIf="activeTab === 'upload'">
    <div class="upload-card">
      <div class="upload-zone" (click)="fileInput.click()">
        <input 
          #fileInput 
          type="file" 
          accept=".pdf" 
          (change)="onFileSelected($event)"
          hidden />
        <div class="upload-content">
          <span class="upload-icon">ğŸ“</span>
          <p class="upload-text">
            <strong>Clique pour choisir ton rapport PDF</strong> ou glisse-le ici
          </p>
          <p class="upload-hint">PDF uniquement (Max 50MB)</p>
        </div>
      </div>

      <div class="selected-file" *ngIf="selectedFile">
        <div class="file-info">
          <span class="file-icon">ğŸ“„</span>
          <div class="file-details">
            <p class="file-name">{{ selectedFile.name }}</p>
            <p class="file-size">{{ formatFileSize(selectedFile.size) }}</p>
          </div>
        </div>
        <button class="remove-file-btn" (click)="removeFile()">
          <span>âœ•</span>
        </button>
      </div>

      <button 
        class="btn-upload"
        (click)="uploadThesis()"
        [disabled]="!selectedFile || isUploading"
        [class.loading]="isUploading">
        <span *ngIf="!isUploading">
          <span class="btn-icon">ğŸš€</span>
          Importer et vÃ©rifier
        </span>
        <span *ngIf="isUploading" class="loading-spinner">
          <span class="spinner"></span>
          Traitement en cours...
        </span>
      </button>
    </div>
  </div>

  <!-- History Tab -->
  <div class="tab-content" *ngIf="activeTab === 'history'">
    <!-- Search and Filter Bar -->
    <div class="controls-bar" *ngIf="theses.length > 0">
      <!-- Search -->
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="text" 
          class="search-input"
          placeholder="Rechercher un rapport..."
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()" />
        <button 
          class="clear-search-btn" 
          *ngIf="searchQuery"
          (click)="searchQuery = ''; onSearchChange()">
          âœ•
        </button>
      </div>

      <!-- Filter Buttons -->
      <div class="filter-group">
        <button 
          class="filter-btn"
          [class.active]="selectedFilter === 'all'"
          (click)="onFilterChange('all')">
          <span class="filter-icon">ğŸ“‹</span>
          Tous
          <span class="filter-count">{{ getFilterCount('all') }}</span>
        </button>
        <button 
          class="filter-btn"
          [class.active]="selectedFilter === 'unchecked'"
          (click)="onFilterChange('unchecked')">
          <span class="filter-icon">â³</span>
          Non vÃ©rifiÃ©s
          <span class="filter-count">{{ getFilterCount('unchecked') }}</span>
        </button>
        <button 
          class="filter-btn filter-risk-high"
          [class.active]="selectedFilter === 'high-risk'"
          (click)="onFilterChange('high-risk')">
          <span class="filter-icon">ğŸ”´</span>
          Risque Ã©levÃ©
          <span class="filter-count">{{ getFilterCount('high-risk') }}</span>
        </button>
        <button 
          class="filter-btn filter-risk-medium"
          [class.active]="selectedFilter === 'medium-risk'"
          (click)="onFilterChange('medium-risk')">
          <span class="filter-icon">ğŸŸ¡</span>
          Risque moyen
          <span class="filter-count">{{ getFilterCount('medium-risk') }}</span>
        </button>
        <button 
          class="filter-btn filter-risk-low"
          [class.active]="selectedFilter === 'low-risk'"
          (click)="onFilterChange('low-risk')">
          <span class="filter-icon">ğŸŸ¢</span>
          Risque faible
          <span class="filter-count">{{ getFilterCount('low-risk') }}</span>
        </button>
      </div>

      <!-- Sort Dropdown -->
      <div class="sort-group">
        <label class="sort-label">
          <span class="sort-icon">â¬â¬</span>
          Trier par:
        </label>
        <select class="sort-select" [(ngModel)]="selectedSort" (change)="onSortChange(selectedSort)">
          <option value="date-desc">Date (plus rÃ©cent)</option>
          <option value="date-asc">Date (plus ancien)</option>
          <option value="name-asc">Nom (A-Z)</option>
          <option value="name-desc">Nom (Z-A)</option>
          <option value="score-desc">Score (Ã©levÃ©)</option>
          <option value="score-asc">Score (faible)</option>
        </select>
      </div>

      <!-- Clear Filters -->
      <button 
        class="clear-filters-btn"
        *ngIf="searchQuery || selectedFilter !== 'all' || selectedSort !== 'date-desc'"
        (click)="clearFilters()">
        <span class="btn-icon">â†º</span>
        RÃ©initialiser
      </button>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner-large"></div>
      <p>Chargement des rapports...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && theses.length === 0">
      <div class="empty-icon">ğŸ“­</div>
      <h3>Aucun rapport importÃ©</h3>
      <p>Commence par importer ton premier rapport</p>
      <button class="btn-secondary" (click)="switchTab('upload')">
        Importer un rapport
      </button>
    </div>

    <!-- No Results State -->
    <div class="empty-state" *ngIf="!isLoading && theses.length > 0 && filteredTheses.length === 0">
      <div class="empty-icon">ğŸ”</div>
      <h3>Aucun rÃ©sultat trouvÃ©</h3>
      <p>Essayez de modifier vos filtres ou votre recherche</p>
      <button class="btn-secondary" (click)="clearFilters()">
        RÃ©initialiser les filtres
      </button>
    </div>

    <!-- Theses Grid -->
    <div class="theses-grid" *ngIf="!isLoading && filteredTheses.length > 0">
      <div class="thesis-card" *ngFor="let thesis of filteredTheses">
        <!-- Risk Badge -->
        <div class="risk-badge" *ngIf="thesis.lastCheckScore !== undefined && thesis.lastCheckScore !== null"
             [ngClass]="{
               'risk-high': thesis.lastCheckScore >= 0.7,
               'risk-medium': thesis.lastCheckScore >= 0.5 && thesis.lastCheckScore < 0.7,
               'risk-low': thesis.lastCheckScore < 0.5
             }">
          <span class="risk-icon" *ngIf="thesis.lastCheckScore >= 0.7">âš ï¸</span>
          <span class="risk-icon" *ngIf="thesis.lastCheckScore >= 0.5 && thesis.lastCheckScore < 0.7">âš¡</span>
          <span class="risk-icon" *ngIf="thesis.lastCheckScore < 0.5">âœ“</span>
          {{ getScorePercentage(thesis.lastCheckScore) }}%
        </div>
        
        <div class="thesis-header">
          <div class="thesis-info">
            <h3 class="thesis-title">{{ thesis.title }}</h3>
            <p class="thesis-meta">
              <span class="meta-item">
                <span class="meta-icon">ğŸ“…</span>
                {{ formatDate(thesis.uploadedAt) }}
              </span>
              <span class="meta-item">
                <span class="meta-icon">ğŸ“„</span>
                {{ thesis.fileName }}
              </span>
              <span class="meta-item" *ngIf="thesis.similarityScore === undefined">
                <span class="meta-icon status-pending">â³</span>
                Non vÃ©rifiÃ©
              </span>
            </p>
          </div>
        </div>

        <div class="thesis-actions">
          <button 
            class="btn-check"
            (click)="checkThesis(thesis.id)"
            [disabled]="isChecking"
            title="Analyser ce rapport pour dÃ©tecter le plagiat">
            <span class="btn-icon">ğŸ”</span>
            {{ thesis.similarityScore !== undefined ? 'Re-vÃ©rifier' : 'VÃ©rifier' }}
          </button>
          
          <button 
            class="btn-delete"
            (click)="deleteThesis(thesis.id, $event)"
            title="Supprimer ce rapport">
            <span class="btn-icon">ğŸ—‘ï¸</span>
            Supprimer
          </button>
        </div>
      </div>
    </div>

    <!-- Results Counter -->
    <div class="results-counter" *ngIf="!isLoading && theses.length > 0">
      Affichage de {{ filteredTheses.length }} sur {{ theses.length }} rapport(s)
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal-overlay" *ngIf="showResult" (click)="closeResult()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">RÃ©sultats de la vÃ©rification</h2>
        <button class="modal-close" (click)="closeResult()">âœ•</button>
      </div>

      <div class="modal-body" *ngIf="currentReport">
        <!-- Score Overview -->
        <div class="score-card">
          <div class="score-circle" [style.border-color]="getColor(currentReport.overallSimilarityScore)">
            <div class="score-value" [style.color]="getColor(currentReport.overallSimilarityScore)">
              {{ getScorePercentage(currentReport.overallSimilarityScore) }}%
            </div>
            <div class="score-label">SimilaritÃ© moyenne</div>
          </div>
          <div class="score-info">
            <h3 class="score-status" [style.color]="getColor(currentReport.overallSimilarityScore)">
              {{ getLabel(currentReport.overallSimilarityScore) }}
            </h3>
            <p class="score-description">
              {{ currentReport.status }}
            </p>
            <p class="score-hint" style="font-size: 0.85em; color: #666; margin-top: 8px;">
              Ce score reprÃ©sente la similaritÃ© moyenne avec les documents comparÃ©s
            </p>
          </div>
        </div>

        <!-- No Matches -->
        <div class="no-matches" *ngIf="currentReport.matches.length === 0">
          <div class="no-matches-icon">âœ¨</div>
          <h3>Aucune similaritÃ© dÃ©tectÃ©e</h3>
          <p>Votre rapport semble original. Aucun contenu similaire n'a Ã©tÃ© trouvÃ© dans notre base de donnÃ©es.</p>
        </div>

        <!-- Matches List -->
        <div class="matches-section" *ngIf="currentReport.matches.length > 0">
          <h3 class="matches-title">
            <span class="matches-icon">âš ï¸</span>
            Rapports similaires dÃ©tectÃ©s ({{ currentReport.matches.length }})
          </h3>

          <div class="matches-list">
            <div class="match-card" *ngFor="let match of currentReport.matches">
              <div class="match-header">
                <div class="match-info">
                  <h4 class="match-title">{{ match.matchedThesisTitle }}</h4>
                  <p class="match-author">
                    <span class="author-icon">ğŸ‘¤</span>
                    {{ match.matchedStudentId }}
                  </p>
                </div>
                <div class="match-score" 
                     [style.background-color]="getColor(match.similarityScore) + '20'" 
                     [style.color]="getColor(match.similarityScore)">
                  {{ getScorePercentage(match.similarityScore) }}%
                </div>
              </div>
              <div class="match-bar">
                <div 
                  class="match-bar-fill" 
                  [style.width.%]="getScorePercentage(match.similarityScore)"
                  [style.background-color]="getColor(match.similarityScore)">
                </div>
              </div>
              
              <button 
                class="btn-view-details"
                (click)="viewDetailedAnalysis(match)"
                [disabled]="isLoadingDetails"
                title="Voir les sections similaires en dÃ©tail">
                <span class="btn-icon">ğŸ”¬</span>
                Voir l'analyse dÃ©taillÃ©e
              </button>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="modal-actions">
          <button class="btn-modal-primary" (click)="closeResult()">
            Compris
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Analysis Modal -->
  <div class="modal-overlay detailed-overlay" *ngIf="showDetailedAnalysis" (click)="closeDetailedAnalysis()">
    <div class="modal-content detailed-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="modal-icon">ğŸ”¬</span>
          Analyse dÃ©taillÃ©e des similaritÃ©s
        </h2>
        <button class="modal-close" (click)="closeDetailedAnalysis()">âœ•</button>
      </div>

      <div class="modal-body detailed-body" *ngIf="detailedAnalysis">
        <!-- Summary Stats -->
        <div class="detail-stats">
          <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
              <div class="stat-value">{{ getScorePercentage(detailedAnalysis.overallSimilarity) }}%</div>
              <div class="stat-label">SimilaritÃ© maximale</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ”</div>
            <div class="stat-content">
              <div class="stat-value">{{ detailedAnalysis.matchesFound }}</div>
              <div class="stat-label">Sections similaires</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“„</div>
            <div class="stat-content">
              <div class="stat-value">{{ detailedAnalysis.totalComparisons }}</div>
              <div class="stat-label">Comparaisons effectuÃ©es</div>
            </div>
          </div>
        </div>

        <!-- Info Banner -->
        <div class="detail-info-banner">
          <span class="info-icon">ğŸ’¡</span>
          <p>Cette analyse compare votre document section par section (environ 500 mots par section) pour identifier prÃ©cisÃ©ment oÃ¹ se trouvent les similaritÃ©s supÃ©rieures Ã  70%.</p>
        </div>

        <!-- No Matches -->
        <div class="no-matches" *ngIf="detailedAnalysis.matchesFound === 0">
          <div class="no-matches-icon">âœ¨</div>
          <h3>Aucune section fortement similaire dÃ©tectÃ©e</h3>
          <p>Aucune section ne dÃ©passe le seuil de 70% de similaritÃ©. Les ressemblances dÃ©tectÃ©es sont mineures ou correspondent Ã  du contenu courant.</p>
        </div>

        <!-- Chunk Matches -->
        <div class="chunks-container" *ngIf="detailedAnalysis.matchesFound > 0">
          <h3 class="chunks-title">
            <span class="chunks-icon">ğŸ“</span>
            Sections similaires trouvÃ©es (â‰¥70%)
          </h3>

          <div class="chunk-list">
            <div class="chunk-comparison" *ngFor="let chunk of detailedAnalysis.chunks; let i = index">
              <!-- Chunk Header -->
              <div class="chunk-header">
                <div class="chunk-number">#{{ i + 1 }}</div>
                <div class="chunk-score"
                     [style.background-color]="getChunkColor(chunk.similarity) + '20'"
                     [style.color]="getChunkColor(chunk.similarity)">
                  <span class="score-icon">âš¡</span>
                  {{ getScorePercentage(chunk.similarity) }}% similaire
                </div>
              </div>

              <!-- Side-by-side comparison -->
              <div class="chunk-content-grid">
                <!-- Your Document -->
                <div class="chunk-side your-doc">
                  <div class="chunk-side-header">
                    <span class="doc-icon">ğŸ“„</span>
                    <span class="doc-label">Votre document</span>
                    <span class="chunk-meta">Section {{ chunk.position1.chunkIndex + 1 }} Â· {{ chunk.wordCount1 }} mots</span>
                  </div>
                  <div class="chunk-text" 
                       [style.border-left-color]="getChunkColor(chunk.similarity)">
                    {{ chunk.text1Chunk }}
                    <span class="text-ellipsis" *ngIf="chunk.text1Chunk.length >= 500">...</span>
                  </div>
                </div>

                <!-- Similarity Indicator -->
                <div class="similarity-arrow">
                  <div class="arrow-icon" [style.color]="getChunkColor(chunk.similarity)">
                    âŸ·
                  </div>
                  <div class="arrow-label">{{ getScorePercentage(chunk.similarity) }}%</div>
                </div>

                <!-- Matched Document -->
                <div class="chunk-side matched-doc">
                  <div class="chunk-side-header">
                    <span class="doc-icon">ğŸ“‹</span>
                    <span class="doc-label">Document comparÃ©</span>
                    <span class="chunk-meta">Section {{ chunk.position2.chunkIndex + 1 }} Â· {{ chunk.wordCount2 }} mots</span>
                  </div>
                  <div class="chunk-text"
                       [style.border-left-color]="getChunkColor(chunk.similarity)">
                    {{ chunk.text2Chunk }}
                    <span class="text-ellipsis" *ngIf="chunk.text2Chunk.length >= 500">...</span>
                  </div>
                </div>
              </div>

              <!-- Similarity Bar -->
              <div class="chunk-similarity-bar">
                <div class="similarity-bar-fill"
                     [style.width.%]="getScorePercentage(chunk.similarity)"
                     [style.background-color]="getChunkColor(chunk.similarity)">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Close Action -->
        <div class="modal-actions">
          <button class="btn-modal-secondary" (click)="closeDetailedAnalysis()">
            <span class="btn-icon">â†</span>
            Retour au rapport
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checking Overlay -->
  <div class="checking-overlay" *ngIf="isChecking">
    <div class="checking-card">
      <div class="spinner-large"></div>
      <h3>VÃ©rification en cours...</h3>
      <p>Analyse de votre rapport avec l'IA</p>
    </div>
  </div>

  <!-- Loading Details Overlay -->
  <div class="checking-overlay" *ngIf="isLoadingDetails">
    <div class="checking-card">
      <div class="spinner-large"></div>
      <h3>Analyse dÃ©taillÃ©e en cours...</h3>
      <p>Comparaison section par section des documents</p>
    </div>
  </div>
</div>